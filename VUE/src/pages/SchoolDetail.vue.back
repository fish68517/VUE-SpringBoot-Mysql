<template>
  <div class="school-detail-page" v-if="school">
    <div class="detail-header">
      <div class="header-content">
        <h1>{{ school.name }}</h1>
        <div class="badges">
          <span class="badge tier">{{ school.tier }}</span>
          <span class="badge city">{{ school.city }}</span>
        </div>
        <div class="actions">
          <button 
            @click="handleFavoriteClick" 
            class="btn-favorite" 
            :class="{ active: isFavorited }"
          >
            {{ isFavorited ? 'â˜… å·²æ”¶è—' : 'â˜† æ”¶è—é™¢æ ¡' }}
          </button>
        </div>
      </div>
    </div>

    <div class="detail-container">
      <div class="main-info">
        <section class="info-section">
          <h2>é™¢æ ¡ç®€ä»‹</h2>
          <p>{{ school.intro }}</p>
          <a :href="school.website" target="_blank" class="website-link">è®¿é—®å®˜ç½‘ &rarr;</a>
        </section>

        <section class="info-section stats-section">
          <h2>ğŸ“Š ç«äº‰æ€åŠ¿åˆ†æ (åŸºäºæœ¬ç«™å¤§æ•°æ®)</h2>
          <div v-if="loadingStats" class="loading-stats">æ•°æ®åŠ è½½ä¸­...</div>
          <div v-else class="charts-container">
            <div class="chart-wrapper">
              <h4>æ”¶è—è€…æœ¬ç§‘èƒŒæ™¯åˆ†å¸ƒ</h4>
              <div ref="tierChart" class="chart-box"></div>
            </div>
            <div class="chart-wrapper">
              <h4>æ”¶è—è€…å››çº§æˆç»©åˆ†å¸ƒ</h4>
              <div ref="cet4Chart" class="chart-box"></div>
            </div>
          </div>
          <p class="stats-footer">å½“å‰å…±æœ‰ {{ stats.totalFavorites || 0 }} ä½åŒå­¦æ”¶è—äº†è¯¥æ ¡</p>
        </section>
        
        <Comments :schoolId="routeId" />
      </div>
      
      <aside class="sidebar">
        </aside>
    </div>

    <ProfileEditModal 
      :visible="showProfileModal" 
      :initialData="currentUserProfile"
      @close="showProfileModal = false"
      @saved="onProfileSaved"
    />
  </div>
</template>

<script>
import schoolService from '../services/schoolService'
import favoriteService from '../services/favoriteService'
import userService from '../services/userService' // å¼•å…¥
import Comments from '../components/Comments.vue'
import ProfileEditModal from '../components/ProfileEditModal.vue' // å¼•å…¥
import * as echarts from 'echarts' // å¼•å…¥ ECharts
import { useRoute } from 'vue-router' // å¦‚æœæ˜¯ Vue 3 setup è¯­æ³•ï¼Œè¿™é‡Œä¿æŒåŸæ ·ï¼›å¦‚æœæ˜¯ Options API çœ‹ä¸‹é¢

export default {
  components: { Comments, ProfileEditModal },
  data() {
    return {
      school: null,
      isFavorited: false,
      routeId: null,
      
      // æ–°å¢çŠ¶æ€
      stats: {},
      loadingStats: false,
      showProfileModal: false,
      currentUserProfile: null,
      tierChartInstance: null,
      cet4ChartInstance: null
    }
  },
  async created() {
    this.routeId = this.$route.params.id
    await this.fetchSchoolDetail()
    await this.checkFavoriteStatus()
    await this.fetchStats() // åŠ è½½å›¾è¡¨æ•°æ®
    this.fetchUserProfile() // é¢„åŠ è½½ç”¨æˆ·ç”»åƒ
  },
  // é¡µé¢é”€æ¯å‰é”€æ¯å›¾è¡¨å®ä¾‹é˜²æ­¢å†…å­˜æ³„æ¼
  beforeUnmount() {
    if (this.tierChartInstance) this.tierChartInstance.dispose()
    if (this.cet4ChartInstance) this.cet4ChartInstance.dispose()
  },
  methods: {
    async fetchSchoolDetail() {
      try {
        const response = await schoolService.getSchoolById(this.routeId)
        this.school = response.data.data
      } catch (error) {
        console.error('Failed to fetch school', error)
      }
    },
    async checkFavoriteStatus() {
      try {
        const response = await favoriteService.checkStatus(this.routeId)
        this.isFavorited = response.data.data.isFavorited
      } catch (error) {
        console.error(error)
      }
    },
    async fetchUserProfile() {
      try {
        const res = await userService.getProfile()
        this.currentUserProfile = res.data.data
      } catch (e) {
        console.error("Failed to fetch profile", e)
      }
    },
    
    // --- æ ¸å¿ƒé€»è¾‘ï¼šæ‹¦æˆªæ”¶è— ---
    async handleFavoriteClick() {
      // 1. å¦‚æœå·²ç»æ˜¯æ”¶è—çŠ¶æ€ï¼Œåˆ™æ˜¯å–æ¶ˆæ”¶è—ï¼Œç›´æ¥æ‰§è¡Œ
      if (this.isFavorited) {
        await this.toggleFavorite()
        return
      }

      // 2. æ£€æŸ¥ç”¨æˆ·ç”»åƒæ˜¯å¦å®Œæ•´
      if (!this.isProfileComplete()) {
        // 3. ä¸å®Œæ•´ -> å¼¹çª—
        this.showProfileModal = true
        return
      }

      // 4. å®Œæ•´ -> æ‰§è¡Œæ”¶è—
      await this.toggleFavorite()
    },

    isProfileComplete() {
      if (!this.currentUserProfile) return false
      // æ£€æŸ¥å¿…å¡«é¡¹ï¼šUndergradTier å’Œ Cet4Score
      return this.currentUserProfile.undergradTier && this.currentUserProfile.cet4Score
    },

    async onProfileSaved() {
      // ç”¨æˆ·åœ¨å¼¹çª—é‡Œä¿å­˜æˆåŠŸåçš„å›è°ƒ
      await this.fetchUserProfile() // åˆ·æ–°æœ¬åœ°ç”»åƒæ•°æ®
      await this.toggleFavorite()   // è‡ªåŠ¨æ‰§è¡Œåˆšæ‰è¢«ä¸­æ–­çš„æ”¶è—æ“ä½œ
      await this.fetchStats()       // åˆ·æ–°å›¾è¡¨ï¼ˆå› ä¸ºå¤šäº†ä¸€ä¸ªæ–°æ ·æœ¬ï¼‰
    },

    async toggleFavorite() {
      try {
        if (this.isFavorited) {
          await favoriteService.removeFavorite(this.routeId)
          this.isFavorited = false
        } else {
          await favoriteService.addFavorite(this.routeId)
          this.isFavorited = true
        }
        // æ”¶è—çŠ¶æ€æ”¹å˜åï¼Œåˆ·æ–°ç»Ÿè®¡æ•°æ®
        this.fetchStats()
      } catch (error) {
        alert('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•')
      }
    },

    // --- å›¾è¡¨ç›¸å…³é€»è¾‘ ---
    async fetchStats() {
      this.loadingStats = true
      try {
        // è°ƒç”¨åç«¯ API (éœ€è¦ä½ åœ¨ schoolService ä¸­æ·»åŠ è¿™ä¸ªæ–¹æ³•)
        // ä¸´æ—¶ç›´æ¥ç”¨ axios æˆ–è€…å‡è®¾ schoolService å·²ç»æœ‰äº†
        // const res = await schoolService.getSchoolStats(this.routeId)
        // è¿™é‡Œæ¨¡æ‹Ÿè°ƒç”¨ï¼Œå®é™…ä½ éœ€è¦å» src/services/schoolService.js æ·»åŠ æ–¹æ³•
        const res = await this.$http.get(`/api/schools/${this.routeId}/stats`) // å‡è®¾æŒ‚è½½äº† $http
        // æˆ–è€…: import axios from 'axios'; const res = await axios.get(...)
        
        this.stats = res.data.data
        this.$nextTick(() => {
          this.initCharts()
        })
      } catch (error) {
        console.error("Stats fetch failed", error)
      } finally {
        this.loadingStats = false
      }
    },

    initCharts() {
      if (!this.stats.tierDistribution) return

      // 1. æœ¬ç§‘å±‚æ¬¡é¥¼å›¾
      const tierData = Object.entries(this.stats.tierDistribution).map(([name, value]) => ({
        name: this.formatTierName(name),
        value: (value * 100).toFixed(1)
      }))
      
      if (!this.tierChartInstance) this.tierChartInstance = echarts.init(this.$refs.tierChart)
      this.tierChartInstance.setOption({
        tooltip: { trigger: 'item', formatter: '{b}: {c}%' },
        series: [{
          type: 'pie',
          radius: ['40%', '70%'],
          data: tierData
        }]
      })

      // 2. å››çº§æˆç»©æŸ±çŠ¶å›¾
      const cet4Data = Object.entries(this.stats.cet4Distribution)
      // ç®€å•æ’åºé€»è¾‘ï¼Œè®©åˆ†æ•°æ®µæŒ‰é¡ºåºæ˜¾ç¤ºï¼ˆæ ¹æ®å®é™… map key æ’åºå¯èƒ½éœ€è¦é¢å¤–é€»è¾‘ï¼‰
      
      if (!this.cet4ChartInstance) this.cet4ChartInstance = echarts.init(this.$refs.cet4Chart)
      this.cet4ChartInstance.setOption({
        tooltip: { trigger: 'axis' },
        xAxis: { type: 'category', data: Object.keys(this.stats.cet4Distribution) },
        yAxis: { type: 'value', name: 'å æ¯”', axisLabel: { formatter: '{value}%' } },
        series: [{
          data: Object.values(this.stats.cet4Distribution).map(v => (v * 100).toFixed(1)),
          type: 'bar',
          itemStyle: { color: '#36cfc9' }
        }]
      })
    },
    
    formatTierName(code) {
      const map = { '985': '985é™¢æ ¡', '211': '211é™¢æ ¡', 'DOUBLE_NON': 'åŒéä¸€æœ¬', 'OTHER': 'å…¶ä»–' }
      return map[code] || code
    }
  }
}
</script>

<style scoped>
/* ä¿æŒåŸæœ‰æ ·å¼ï¼Œæ–°å¢å›¾è¡¨æ ·å¼ */
.stats-section {
  margin-top: 30px;
  background: #fff;
  padding: 20px;
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

.charts-container {
  display: flex;
  flex-wrap: wrap;
  gap: 20px;
  margin-top: 20px;
}

.chart-wrapper {
  flex: 1;
  min-width: 300px;
  background: #f9f9f9;
  padding: 15px;
  border-radius: 8px;
}

.chart-box {
  width: 100%;
  height: 250px;
}

.stats-footer {
  text-align: center;
  color: #999;
  font-size: 12px;
  margin-top: 15px;
}

.btn-favorite {
  padding: 10px 20px;
  border: 1px solid #1890ff;
  background: white;
  color: #1890ff;
  border-radius: 4px;
  cursor: pointer;
  transition: all 0.3s;
}

.btn-favorite.active {
  background: #1890ff;
  color: white;
}
</style>