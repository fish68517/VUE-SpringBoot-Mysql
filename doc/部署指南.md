# 部署指南

本文档详细说明如何在不同环境中部署星落宠物用品销售网站系统。

## 目录

1. [开发环境部署](#开发环境部署)
2. [生产环境部署](#生产环境部署)
3. [Docker 部署](#docker-部署)
4. [常见问题](#常见问题)
5. [故障排查](#故障排查)

---

## 开发环境部署

### 系统要求

| 组件 | 版本 | 说明 |
|------|------|------|
| Java | 17+ | 后端运行环境 |
| Node.js | 16.0+ | 前端构建环境 |
| MySQL | 8.0+ | 数据库 |
| Maven | 3.6+ | Java 构建工具 |
| Git | 2.0+ | 版本控制 |

### 后端部署

#### 1. 环境准备

```bash
# 检查 Java 版本
java -version

# 检查 Maven 版本
mvn -version

# 检查 MySQL 版本
mysql --version
```

#### 2. 数据库初始化

```bash
# 创建数据库
mysql -u root -p
CREATE DATABASE petshop CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
EXIT;

# 导入初始化脚本
mysql -u root -p petshop < SpringBoot/src/main/resources/schema.sql
```

#### 3. 配置应用

编辑 `SpringBoot/src/main/resources/application.yml`：

```yaml
spring:
  application:
    name: petshop
  
  datasource:
    url: jdbc:mysql://localhost:3306/petshop?useUnicode=true&characterEncoding=utf8&useSSL=false&serverTimezone=Asia/Shanghai
    username: root
    password: your_password
    driver-class-name: com.mysql.cj.jdbc.Driver
  
  jpa:
    hibernate:
      ddl-auto: update
    show-sql: false
    properties:
      hibernate:
        format_sql: true
        dialect: org.hibernate.dialect.MySQL8Dialect
  
  servlet:
    multipart:
      max-file-size: 10MB
      max-request-size: 10MB

server:
  port: 8080
  servlet:
    context-path: /

logging:
  level:
    root: INFO
    com.xingluo.petshop: DEBUG
```

#### 4. 启动后端服务

```bash
cd SpringBoot

# 方式一：使用 Maven 插件
mvn spring-boot:run

# 方式二：先编译再运行
mvn clean install
java -jar target/petshop-1.0.0.jar
```

后端服务将在 `http://localhost:8080` 启动

#### 5. 验证后端

```bash
# 测试健康检查端点
curl http://localhost:8080/api/user/profile

# 查看日志
tail -f SpringBoot/target/logs/petshop.log
```

### 前端部署

#### 1. 环境准备

```bash
# 检查 Node.js 版本
node --version

# 检查 npm 版本
npm --version
```

#### 2. 安装依赖

```bash
cd VUE
npm install
```

#### 3. 配置 API 地址

编辑 `VUE/src/utils/request.js`：

```javascript
const request = axios.create({
  baseURL: 'http://localhost:8080/api',
  timeout: 5000
})
```

#### 4. 启动前端开发服务器

```bash
npm run dev
```

前端应用将在 `http://localhost:5173` 启动

#### 5. 验证前端

打开浏览器访问 `http://localhost:5173`，应该能看到首页

### 开发环境完整启动流程

```bash
# 终端1：启动 MySQL
# 确保 MySQL 服务已启动

# 终端2：启动后端
cd SpringBoot
mvn spring-boot:run

# 终端3：启动前端
cd VUE
npm run dev

# 在浏览器中打开
# http://localhost:5173
```

---

## 生产环境部署

### 系统要求

- 服务器操作系统：Linux (CentOS 7+, Ubuntu 18.04+)
- CPU：2核+
- 内存：4GB+
- 磁盘：50GB+
- 带宽：10Mbps+

### 架构设计

```
┌─────────────────────────────────────────────────────────┐
│                    CDN / 静态资源                        │
└─────────────────────────────────────────────────────────┘
                        │
┌─────────────────────────────────────────────────────────┐
│                  Nginx 反向代理                          │
│              (负载均衡、SSL、缓存)                       │
└─────────────────────────────────────────────────────────┘
                        │
        ┌───────────────┼───────────────┐
        │               │               │
┌───────────────┐ ┌───────────────┐ ┌───────────────┐
│ Spring Boot 1 │ │ Spring Boot 2 │ │ Spring Boot 3 │
│   (8080)      │ │   (8081)      │ │   (8082)      │
└───────────────┘ └───────────────┘ └───────────────┘
        │               │               │
        └───────────────┼───────────────┘
                        │
        ┌───────────────┴───────────────┐
        │                               │
┌──────────────────┐          ┌──────────────────┐
│   MySQL Master   │          │   MySQL Slave    │
│   (主库)         │          │   (从库)         │
└──────────────────┘          └──────────────────┘
        │
        └─ 定期备份
```

### 后端部署

#### 1. 服务器准备

```bash
# 更新系统
sudo yum update -y

# 安装 Java
sudo yum install java-17-openjdk java-17-openjdk-devel -y

# 验证 Java 安装
java -version

# 创建应用目录
sudo mkdir -p /opt/petshop
sudo chown -R $USER:$USER /opt/petshop
```

#### 2. 构建应用

```bash
cd SpringBoot
mvn clean package -DskipTests
```

生成的 JAR 文件位于 `target/petshop-1.0.0.jar`

#### 3. 上传到服务器

```bash
scp target/petshop-1.0.0.jar user@server:/opt/petshop/
scp src/main/resources/application-prod.yml user@server:/opt/petshop/
```

#### 4. 配置生产环境

创建 `application-prod.yml`：

```yaml
spring:
  application:
    name: petshop
  
  datasource:
    url: jdbc:mysql://db.example.com:3306/petshop?useUnicode=true&characterEncoding=utf8&useSSL=true&serverTimezone=Asia/Shanghai
    username: petshop_user
    password: ${DB_PASSWORD}
    driver-class-name: com.mysql.cj.jdbc.Driver
    hikari:
      maximum-pool-size: 20
      minimum-idle: 5
      connection-timeout: 30000
  
  jpa:
    hibernate:
      ddl-auto: validate
    show-sql: false
    properties:
      hibernate:
        format_sql: false
        dialect: org.hibernate.dialect.MySQL8Dialect
  
  servlet:
    multipart:
      max-file-size: 10MB
      max-request-size: 10MB

server:
  port: 8080
  servlet:
    context-path: /
  compression:
    enabled: true
    min-response-size: 1024

logging:
  level:
    root: WARN
    com.xingluo.petshop: INFO
  file:
    name: /var/log/petshop/petshop.log
    max-size: 100MB
    max-history: 30
```

#### 5. 创建启动脚本

创建 `/opt/petshop/start.sh`：

```bash
#!/bin/bash

APP_NAME="petshop"
JAR_FILE="/opt/petshop/petshop-1.0.0.jar"
LOG_DIR="/var/log/petshop"
PID_FILE="/var/run/petshop.pid"

# 创建日志目录
mkdir -p $LOG_DIR

# 启动应用
nohup java -Xms2g -Xmx2g \
  -Dspring.profiles.active=prod \
  -Dspring.config.location=file:/opt/petshop/application-prod.yml \
  -jar $JAR_FILE > $LOG_DIR/petshop.log 2>&1 &

echo $! > $PID_FILE
echo "应用已启动，PID: $(cat $PID_FILE)"
```

#### 6. 创建停止脚本

创建 `/opt/petshop/stop.sh`：

```bash
#!/bin/bash

PID_FILE="/var/run/petshop.pid"

if [ -f $PID_FILE ]; then
    PID=$(cat $PID_FILE)
    kill $PID
    echo "应用已停止，PID: $PID"
    rm $PID_FILE
else
    echo "应用未运行"
fi
```

#### 7. 启动应用

```bash
chmod +x /opt/petshop/start.sh
chmod +x /opt/petshop/stop.sh

/opt/petshop/start.sh

# 查看日志
tail -f /var/log/petshop/petshop.log
```

#### 8. 配置 Systemd 服务（可选）

创建 `/etc/systemd/system/petshop.service`：

```ini
[Unit]
Description=Petshop Application
After=network.target

[Service]
Type=simple
User=petshop
WorkingDirectory=/opt/petshop
ExecStart=/opt/petshop/start.sh
ExecStop=/opt/petshop/stop.sh
Restart=on-failure
RestartSec=10

[Install]
WantedBy=multi-user.target
```

启用服务：

```bash
sudo systemctl daemon-reload
sudo systemctl enable petshop
sudo systemctl start petshop
sudo systemctl status petshop
```

### 前端部署

#### 1. 构建前端

```bash
cd VUE

# 配置生产环境 API 地址
# 编辑 VUE/src/utils/request.js
# 修改 baseURL 为生产环境地址

npm run build
```

生成的静态文件位于 `dist/` 目录

#### 2. 上传到服务器

```bash
scp -r dist/* user@server:/var/www/petshop/
```

#### 3. 配置 Nginx

创建 `/etc/nginx/conf.d/petshop.conf`：

```nginx
upstream petshop_backend {
    server localhost:8080;
    server localhost:8081;
    server localhost:8082;
}

server {
    listen 80;
    server_name petshop.example.com;
    
    # 重定向到 HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name petshop.example.com;
    
    # SSL 证书配置
    ssl_certificate /etc/nginx/ssl/petshop.crt;
    ssl_certificate_key /etc/nginx/ssl/petshop.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    
    # 前端静态文件
    location / {
        root /var/www/petshop;
        try_files $uri $uri/ /index.html;
        expires 1d;
        add_header Cache-Control "public, immutable";
    }
    
    # 后端 API
    location /api/ {
        proxy_pass http://petshop_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
    
    # 静态资源缓存
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 30d;
        add_header Cache-Control "public, immutable";
    }
    
    # 禁止访问敏感文件
    location ~ /\. {
        deny all;
    }
}
```

#### 4. 重启 Nginx

```bash
sudo nginx -t
sudo systemctl restart nginx
```

### 数据库部署

#### 1. MySQL 主从复制配置

**主库配置：**

编辑 `/etc/my.cnf`：

```ini
[mysqld]
server-id = 1
log-bin = mysql-bin
binlog-format = ROW
binlog-row-image = FULL
```

重启 MySQL：

```bash
sudo systemctl restart mysqld
```

创建复制用户：

```sql
CREATE USER 'repl'@'%' IDENTIFIED BY 'repl_password';
GRANT REPLICATION SLAVE ON *.* TO 'repl'@'%';
FLUSH PRIVILEGES;

SHOW MASTER STATUS;
```

**从库配置：**

编辑 `/etc/my.cnf`：

```ini
[mysqld]
server-id = 2
relay-log = mysql-relay-bin
```

配置复制：

```sql
CHANGE MASTER TO
  MASTER_HOST = 'master_ip',
  MASTER_USER = 'repl',
  MASTER_PASSWORD = 'repl_password',
  MASTER_LOG_FILE = 'mysql-bin.000001',
  MASTER_LOG_POS = 154;

START SLAVE;
SHOW SLAVE STATUS;
```

#### 2. 备份策略

```bash
# 每天凌晨2点执行完整备份
0 2 * * * mysqldump -u root -p${DB_PASSWORD} petshop > /backup/petshop_$(date +\%Y\%m\%d).sql

# 每小时执行增量备份
0 * * * * mysqlbinlog --raw --read-from-remote-server -h localhost -u root -p${DB_PASSWORD} mysql-bin.* > /backup/incremental_$(date +\%Y\%m\%d\%H).sql
```

---

## Docker 部署

### 前置要求

- Docker 20.10+
- Docker Compose 2.0+

### 创建 Dockerfile

#### 后端 Dockerfile

创建 `SpringBoot/Dockerfile`：

```dockerfile
FROM openjdk:17-jdk-slim

WORKDIR /app

COPY target/petshop-1.0.0.jar petshop.jar
COPY src/main/resources/application-docker.yml application.yml

EXPOSE 8080

ENTRYPOINT ["java", "-Xms512m", "-Xmx1024m", "-jar", "petshop.jar"]
```

#### 前端 Dockerfile

创建 `VUE/Dockerfile`：

```dockerfile
# 构建阶段
FROM node:16-alpine as builder

WORKDIR /app

COPY package*.json ./
RUN npm install

COPY . .
RUN npm run build

# 运行阶段
FROM nginx:alpine

COPY --from=builder /app/dist /usr/share/nginx/html
COPY nginx.conf /etc/nginx/conf.d/default.conf

EXPOSE 80

CMD ["nginx", "-g", "daemon off;"]
```

### 创建 Docker Compose 配置

创建 `docker-compose.yml`：

```yaml
version: '3.8'

services:
  mysql:
    image: mysql:8.0
    container_name: petshop-mysql
    environment:
      MYSQL_ROOT_PASSWORD: root_password
      MYSQL_DATABASE: petshop
      MYSQL_USER: petshop_user
      MYSQL_PASSWORD: petshop_password
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql
      - ./SpringBoot/src/main/resources/schema.sql:/docker-entrypoint-initdb.d/schema.sql
    networks:
      - petshop-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5

  backend:
    build:
      context: ./SpringBoot
      dockerfile: Dockerfile
    container_name: petshop-backend
    environment:
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/petshop?useUnicode=true&characterEncoding=utf8&useSSL=false&serverTimezone=Asia/Shanghai
      SPRING_DATASOURCE_USERNAME: petshop_user
      SPRING_DATASOURCE_PASSWORD: petshop_password
    ports:
      - "8080:8080"
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - petshop-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/api/user/profile"]
      interval: 30s
      timeout: 10s
      retries: 3

  frontend:
    build:
      context: ./VUE
      dockerfile: Dockerfile
    container_name: petshop-frontend
    ports:
      - "80:80"
    depends_on:
      - backend
    networks:
      - petshop-network

volumes:
  mysql_data:

networks:
  petshop-network:
    driver: bridge
```

### 启动 Docker 容器

```bash
# 构建镜像
docker-compose build

# 启动容器
docker-compose up -d

# 查看日志
docker-compose logs -f

# 停止容器
docker-compose down
```

---

## 常见问题

### Q: 如何修改数据库连接信息？

A: 编辑 `application.yml` 中的数据库配置：

```yaml
spring:
  datasource:
    url: jdbc:mysql://localhost:3306/petshop
    username: root
    password: your_password
```

### Q: 如何修改前端 API 地址？

A: 编辑 `VUE/src/utils/request.js`：

```javascript
const request = axios.create({
  baseURL: 'http://your-api-server/api'
})
```

### Q: 如何启用 HTTPS？

A: 
1. 获取 SSL 证书（Let's Encrypt 或其他 CA）
2. 配置 Nginx SSL
3. 重定向 HTTP 到 HTTPS

### Q: 如何进行性能优化？

A:
1. 启用数据库连接池
2. 配置 Nginx 缓存
3. 启用 Gzip 压缩
4. 使用 CDN 加速静态资源

### Q: 如何监控应用状态？

A: 使用以下工具：
- Prometheus + Grafana（监控）
- ELK Stack（日志分析）
- Sentry（错误追踪）

---

## 故障排查

### 后端无法启动

**症状：** 应用启动失败

**排查步骤：**

1. 检查 Java 版本
   ```bash
   java -version
   ```

2. 检查数据库连接
   ```bash
   mysql -u root -p -h localhost
   ```

3. 查看应用日志
   ```bash
   tail -f /var/log/petshop/petshop.log
   ```

4. 检查端口占用
   ```bash
   lsof -i :8080
   ```

### 前端无法连接后端

**症状：** 前端请求失败，控制台显示 CORS 错误

**排查步骤：**

1. 检查后端是否运行
   ```bash
   curl http://localhost:8080/api/user/profile
   ```

2. 检查 CORS 配置
   ```java
   // 确保 CorsConfig 已配置
   ```

3. 检查 API 地址配置
   ```javascript
   // VUE/src/utils/request.js
   ```

4. 检查网络连接
   ```bash
   ping backend_server
   ```

### 数据库连接失败

**症状：** 应用日志显示数据库连接错误

**排查步骤：**

1. 检查 MySQL 是否运行
   ```bash
   sudo systemctl status mysqld
   ```

2. 检查用户名和密码
   ```bash
   mysql -u petshop_user -p -h localhost
   ```

3. 检查数据库是否存在
   ```sql
   SHOW DATABASES;
   ```

4. 检查防火墙设置
   ```bash
   sudo firewall-cmd --list-all
   ```

### 性能问题

**症状：** 应用响应缓慢

**排查步骤：**

1. 检查数据库性能
   ```sql
   SHOW PROCESSLIST;
   SHOW SLOW LOGS;
   ```

2. 检查应用内存使用
   ```bash
   jps -l
   jstat -gc <pid>
   ```

3. 检查网络延迟
   ```bash
   ping server
   traceroute server
   ```

4. 启用查询日志分析
   ```sql
   SET GLOBAL slow_query_log = 'ON';
   SET GLOBAL long_query_time = 2;
   ```

---

## 支持

如有问题，请参考：
- 项目 README：README.md
- 数据库初始化指南：doc/数据库初始化指南.md
- 设计文档：doc/设计文档.md
