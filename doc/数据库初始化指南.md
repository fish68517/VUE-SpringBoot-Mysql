# 数据库初始化指南

## 概述

本文档说明如何初始化星落宠物用品销售网站的数据库。系统使用 MySQL 8.0 作为数据库，包含15个核心数据表。

## 前置要求

- MySQL 8.0 或更高版本
- 数据库管理工具（如 MySQL Workbench、Navicat 或命令行工具）
- 足够的磁盘空间（至少 100MB）

## 快速初始化

### 方法一：使用命令行（推荐）

1. **打开终端/命令行**

2. **创建数据库**

```bash
mysql -u root -p
```

输入 MySQL root 用户密码后，执行：

```sql
CREATE DATABASE IF NOT EXISTS petshop DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
EXIT;
```

3. **导入初始化脚本**

```bash
mysql -u root -p petshop < SpringBoot/src/main/resources/schema.sql
```

输入 MySQL root 用户密码，脚本将自动创建所有表结构。

### 方法二：使用 MySQL Workbench

1. 打开 MySQL Workbench
2. 连接到 MySQL 服务器
3. 创建新的 SQL 脚本标签
4. 打开 `SpringBoot/src/main/resources/schema.sql` 文件
5. 执行脚本（Ctrl+Shift+Enter 或点击执行按钮）

### 方法三：使用 Navicat

1. 打开 Navicat
2. 连接到 MySQL 服务器
3. 右键点击连接，选择"新建数据库"
4. 输入数据库名称 `petshop`，字符集选择 `utf8mb4`
5. 右键点击新建的数据库，选择"运行 SQL 文件"
6. 选择 `SpringBoot/src/main/resources/schema.sql` 文件

## 数据库结构

### 表清单

| 序号 | 表名 | 说明 | 记录数 |
|------|------|------|--------|
| 1 | user | 用户表 | 0 |
| 2 | pet | 宠物档案表 | 0 |
| 3 | shop | 店铺表 | 0 |
| 4 | category | 商品分类表 | 0 |
| 5 | product | 商品表 | 0 |
| 6 | cart | 购物车表 | 0 |
| 7 | orders | 订单表 | 0 |
| 8 | order_item | 订单明细表 | 0 |
| 9 | review | 商品评价表 | 0 |
| 10 | community_post | 社区帖子表 | 0 |
| 11 | community_reply | 社区评论表 | 0 |
| 12 | post_like | 帖子点赞表 | 0 |
| 13 | coupon | 优惠券表 | 0 |
| 14 | user_coupon | 用户优惠券表 | 0 |
| 15 | browse_history | 浏览历史表 | 0 |

### 表关系图

```
user (1) ──────────────── (n) pet
  │
  ├─ (1) ──────────────── (n) shop
  │
  ├─ (1) ──────────────── (n) orders
  │
  ├─ (1) ──────────────── (n) cart
  │
  ├─ (1) ──────────────── (n) review
  │
  ├─ (1) ──────────────── (n) community_post
  │
  ├─ (1) ──────────────── (n) community_reply
  │
  ├─ (1) ──────────────── (n) post_like
  │
  └─ (1) ──────────────── (n) user_coupon

shop (1) ──────────────── (n) product
  │
  └─ (1) ──────────────── (n) coupon

category (1) ──────────────── (n) product

product (1) ──────────────── (n) cart
  │
  ├─ (1) ──────────────── (n) order_item
  │
  ├─ (1) ──────────────── (n) review
  │
  └─ (1) ──────────────── (n) browse_history

orders (1) ──────────────── (n) order_item

coupon (1) ──────────────── (n) user_coupon

community_post (1) ──────────────── (n) community_reply
  │
  └─ (1) ──────────────── (n) post_like
```

## 表详细说明

### 1. user（用户表）

存储系统用户信息，支持三种角色：普通用户(USER)、店家(SHOP)、管理员(ADMIN)。

| 字段 | 类型 | 说明 | 约束 |
|------|------|------|------|
| id | BIGINT | 主键 | AUTO_INCREMENT |
| username | VARCHAR(50) | 用户名 | UNIQUE, NOT NULL |
| password | VARCHAR(255) | 密码 | NOT NULL |
| nickname | VARCHAR(50) | 昵称 | |
| email | VARCHAR(100) | 邮箱 | |
| phone | VARCHAR(20) | 手机号 | |
| avatar | VARCHAR(255) | 头像URL | |
| address | VARCHAR(255) | 地址 | |
| role | VARCHAR(20) | 角色 | DEFAULT 'USER' |
| status | INT | 状态(0禁用/1启用) | DEFAULT 1 |
| create_time | DATETIME | 创建时间 | DEFAULT CURRENT_TIMESTAMP |
| update_time | DATETIME | 更新时间 | ON UPDATE CURRENT_TIMESTAMP |

**索引：**
- idx_username: 用户名索引（用于登录查询）
- idx_role: 角色索引（用于权限查询）

### 2. pet（宠物档案表）

存储用户的宠物信息，用于个性化推荐。

| 字段 | 类型 | 说明 |
|------|------|------|
| id | BIGINT | 主键 |
| user_id | BIGINT | 用户ID（外键） |
| name | VARCHAR(50) | 宠物名称 |
| species | VARCHAR(50) | 种类（猫/狗/其他） |
| age | INT | 年龄 |
| gender | VARCHAR(10) | 性别 |
| avatar | VARCHAR(255) | 头像URL |
| create_time | DATETIME | 创建时间 |

### 3. shop（店铺表）

存储店家的店铺信息。

| 字段 | 类型 | 说明 |
|------|------|------|
| id | BIGINT | 主键 |
| user_id | BIGINT | 店主用户ID（外键） |
| name | VARCHAR(100) | 店铺名称 |
| description | TEXT | 店铺描述 |
| logo | VARCHAR(255) | 店铺Logo |
| contact | VARCHAR(100) | 联系方式 |
| status | INT | 状态(0待审核/1正常/2禁用) |
| create_time | DATETIME | 创建时间 |
| update_time | DATETIME | 更新时间 |

**状态说明：**
- 0: 待审核（新建店铺需要管理员审核）
- 1: 正常（可以销售商品）
- 2: 禁用（被管理员禁用）

### 4. category（商品分类表）

存储商品分类信息，支持多级分类。

| 字段 | 类型 | 说明 |
|------|------|------|
| id | BIGINT | 主键 |
| name | VARCHAR(50) | 分类名称 |
| parent_id | BIGINT | 父分类ID（支持多级分类） |
| sort_order | INT | 排序顺序 |
| create_time | DATETIME | 创建时间 |

### 5. product（商品表）

存储商品信息，包括价格、库存、状态等。

| 字段 | 类型 | 说明 |
|------|------|------|
| id | BIGINT | 主键 |
| shop_id | BIGINT | 店铺ID（外键） |
| category_id | BIGINT | 分类ID（外键） |
| name | VARCHAR(100) | 商品名称 |
| description | TEXT | 商品描述 |
| price | DECIMAL(10,2) | 价格 |
| stock | INT | 库存数量 |
| image | VARCHAR(255) | 主图URL |
| images | TEXT | 商品图片(JSON数组) |
| status | INT | 状态(0下架/1上架/2待审核) |
| sales | INT | 销量 |
| create_time | DATETIME | 创建时间 |
| update_time | DATETIME | 更新时间 |

**状态说明：**
- 0: 下架（用户端不可见）
- 1: 上架（用户端可见）
- 2: 待审核（新建商品需要管理员审核）

### 6. cart（购物车表）

存储用户的购物车信息。

| 字段 | 类型 | 说明 |
|------|------|------|
| id | BIGINT | 主键 |
| user_id | BIGINT | 用户ID（外键） |
| product_id | BIGINT | 商品ID（外键） |
| quantity | INT | 数量 |
| create_time | DATETIME | 创建时间 |
| update_time | DATETIME | 更新时间 |

**约束：**
- 联合唯一索引(user_id, product_id)：同一用户不能重复添加同一商品

### 7. orders（订单表）

存储订单信息。

| 字段 | 类型 | 说明 |
|------|------|------|
| id | BIGINT | 主键 |
| order_no | VARCHAR(50) | 订单号（唯一） |
| user_id | BIGINT | 用户ID（外键） |
| shop_id | BIGINT | 店铺ID（外键） |
| total_amount | DECIMAL(10,2) | 总金额 |
| status | INT | 订单状态 |
| receiver_name | VARCHAR(50) | 收货人 |
| receiver_phone | VARCHAR(20) | 收货电话 |
| receiver_address | VARCHAR(255) | 收货地址 |
| remark | VARCHAR(255) | 备注 |
| pay_time | DATETIME | 支付时间 |
| ship_time | DATETIME | 发货时间 |
| create_time | DATETIME | 创建时间 |
| update_time | DATETIME | 更新时间 |

**订单状态说明：**
- 0: 待支付（用户已提交订单，等待支付）
- 1: 待发货（用户已支付，等待店家发货）
- 2: 已发货（店家已发货，等待用户收货）
- 3: 已完成（用户已确认收货）
- 4: 已取消（订单已取消）

### 8. order_item（订单明细表）

存储订单中的商品明细。

| 字段 | 类型 | 说明 |
|------|------|------|
| id | BIGINT | 主键 |
| order_id | BIGINT | 订单ID（外键） |
| product_id | BIGINT | 商品ID（外键） |
| product_name | VARCHAR(100) | 商品名称（快照） |
| product_image | VARCHAR(255) | 商品图片（快照） |
| price | DECIMAL(10,2) | 单价（快照） |
| quantity | INT | 数量 |
| subtotal | DECIMAL(10,2) | 小计 |

### 9. review（商品评价表）

存储用户对商品的评价。

| 字段 | 类型 | 说明 |
|------|------|------|
| id | BIGINT | 主键 |
| user_id | BIGINT | 用户ID（外键） |
| product_id | BIGINT | 商品ID（外键） |
| order_id | BIGINT | 订单ID（外键） |
| rating | INT | 评分(1-5) |
| content | TEXT | 评价内容 |
| images | TEXT | 评价图片(JSON数组) |
| create_time | DATETIME | 创建时间 |

### 10. community_post（社区帖子表）

存储社区帖子信息。

| 字段 | 类型 | 说明 |
|------|------|------|
| id | BIGINT | 主键 |
| user_id | BIGINT | 用户ID（外键） |
| title | VARCHAR(100) | 标题 |
| content | TEXT | 内容 |
| images | TEXT | 图片(JSON数组) |
| likes | INT | 点赞数 |
| views | INT | 浏览数 |
| status | INT | 状态(0正常/1已删除) |
| create_time | DATETIME | 创建时间 |
| update_time | DATETIME | 更新时间 |

### 11. community_reply（社区评论表）

存储社区帖子的评论。

| 字段 | 类型 | 说明 |
|------|------|------|
| id | BIGINT | 主键 |
| post_id | BIGINT | 帖子ID（外键） |
| user_id | BIGINT | 用户ID（外键） |
| content | TEXT | 评论内容 |
| create_time | DATETIME | 创建时间 |

### 12. post_like（帖子点赞表）

存储用户对帖子的点赞记录。

| 字段 | 类型 | 说明 |
|------|------|------|
| id | BIGINT | 主键 |
| post_id | BIGINT | 帖子ID（外键） |
| user_id | BIGINT | 用户ID（外键） |
| create_time | DATETIME | 创建时间 |

**约束：**
- 联合唯一索引(post_id, user_id)：同一用户只能点赞一次

### 13. coupon（优惠券表）

存储店家发放的优惠券。

| 字段 | 类型 | 说明 |
|------|------|------|
| id | BIGINT | 主键 |
| shop_id | BIGINT | 店铺ID（外键） |
| name | VARCHAR(100) | 优惠券名称 |
| discount_amount | DECIMAL(10,2) | 折扣金额 |
| min_amount | DECIMAL(10,2) | 最低消费金额 |
| total_count | INT | 发放总数 |
| used_count | INT | 已使用数量 |
| start_time | DATETIME | 开始时间 |
| end_time | DATETIME | 结束时间 |
| status | INT | 状态(0禁用/1启用) |
| create_time | DATETIME | 创建时间 |

### 14. user_coupon（用户优惠券表）

存储用户领取的优惠券。

| 字段 | 类型 | 说明 |
|------|------|------|
| id | BIGINT | 主键 |
| user_id | BIGINT | 用户ID（外键） |
| coupon_id | BIGINT | 优惠券ID（外键） |
| order_id | BIGINT | 使用的订单ID（外键） |
| status | INT | 状态(0未使用/1已使用/2已过期) |
| receive_time | DATETIME | 领取时间 |
| use_time | DATETIME | 使用时间 |

### 15. browse_history（浏览历史表）

存储用户的商品浏览历史，用于推荐。

| 字段 | 类型 | 说明 |
|------|------|------|
| id | BIGINT | 主键 |
| user_id | BIGINT | 用户ID（外键） |
| product_id | BIGINT | 商品ID（外键） |
| create_time | DATETIME | 浏览时间 |

## 数据库配置

### MySQL 配置建议

1. **字符集**
   - 使用 utf8mb4 支持表情符号
   - 排序规则：utf8mb4_unicode_ci

2. **性能优化**
   - 启用查询缓存
   - 调整 max_connections（根据并发用户数）
   - 调整 innodb_buffer_pool_size（推荐为物理内存的 50-80%）

3. **备份策略**
   - 每天进行完整备份
   - 启用二进制日志用于增量备份
   - 定期测试备份恢复

## 初始化后的操作

### 1. 验证数据库

```sql
USE petshop;
SHOW TABLES;
```

应该显示15个表。

### 2. 检查表结构

```sql
DESCRIBE user;
DESCRIBE product;
-- 等等
```

### 3. 添加初始数据（可选）

#### 添加管理员用户

```sql
INSERT INTO user (username, password, nickname, email, phone, role, status) 
VALUES ('admin', 'admin123', '管理员', 'admin@petshop.com', '13800000000', 'ADMIN', 1);
```

#### 添加商品分类

```sql
INSERT INTO category (name, sort_order) VALUES 
('狗粮', 1),
('猫粮', 2),
('玩具', 3),
('护理用品', 4),
('服装', 5);
```

#### 添加测试店铺

```sql
INSERT INTO shop (user_id, name, description, status) 
VALUES (1, '宠物用品旗舰店', '专业宠物用品销售', 1);
```

## 常见问题

### Q: 如何重置数据库？

A: 执行以下命令：

```bash
mysql -u root -p -e "DROP DATABASE petshop;"
mysql -u root -p petshop < SpringBoot/src/main/resources/schema.sql
```

### Q: 如何备份数据库？

A: 使用 mysqldump 命令：

```bash
mysqldump -u root -p petshop > petshop_backup.sql
```

### Q: 如何恢复数据库备份？

A: 使用以下命令：

```bash
mysql -u root -p petshop < petshop_backup.sql
```

### Q: 如何修改数据库用户密码？

A: 使用以下命令：

```sql
ALTER USER 'root'@'localhost' IDENTIFIED BY 'new_password';
FLUSH PRIVILEGES;
```

### Q: 如何查看数据库大小？

A: 使用以下查询：

```sql
SELECT 
    table_schema,
    ROUND(SUM(data_length + index_length) / 1024 / 1024, 2) AS size_mb
FROM information_schema.tables
WHERE table_schema = 'petshop'
GROUP BY table_schema;
```

## 性能优化建议

### 1. 索引优化

已有的索引：
- user: idx_username, idx_role
- pet: idx_user_id
- shop: idx_user_id, idx_status
- product: idx_shop_id, idx_category_id, idx_status, idx_name
- cart: uk_user_product, idx_user_id
- orders: idx_order_no, idx_user_id, idx_shop_id, idx_status
- order_item: idx_order_id
- review: idx_product_id, idx_user_id
- community_post: idx_user_id, idx_status, idx_create_time
- community_reply: idx_post_id
- post_like: uk_post_user
- coupon: idx_shop_id, idx_status
- user_coupon: idx_user_id, idx_coupon_id, idx_status
- browse_history: idx_user_id, idx_create_time

### 2. 查询优化

- 使用分页查询避免一次性加载大量数据
- 使用 EXPLAIN 分析慢查询
- 定期更新表统计信息

### 3. 定期维护

```sql
-- 优化表
OPTIMIZE TABLE user, product, orders;

-- 分析表
ANALYZE TABLE user, product, orders;

-- 检查表
CHECK TABLE user, product, orders;
```

## 支持

如有问题，请参考：
- MySQL 官方文档：https://dev.mysql.com/doc/
- 项目 README：README.md
- 设计文档：doc/设计文档.md
