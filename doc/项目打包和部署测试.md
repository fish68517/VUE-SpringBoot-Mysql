# 项目打包和部署测试指南

本文档说明如何打包项目、进行部署测试，以及验证系统功能。

## 目录

1. [后端打包](#后端打包)
2. [前端打包](#前端打包)
3. [部署测试](#部署测试)
4. [功能验证](#功能验证)
5. [性能测试](#性能测试)
6. [常见问题](#常见问题)

---

## 后端打包

### 前置要求

- Java 17+
- Maven 3.6+
- Git

### 打包步骤

#### 1. 清理和编译

```bash
cd SpringBoot

# 清理之前的构建
mvn clean

# 编译项目
mvn compile
```

#### 2. 运行测试

```bash
# 运行所有测试
mvn test

# 跳过测试进行打包（如果测试失败）
mvn package -DskipTests
```

#### 3. 打包应用

```bash
# 生成 JAR 包
mvn package

# 或者使用 assembly 插件生成包含依赖的 JAR
mvn assembly:assembly
```

生成的 JAR 文件位于 `target/` 目录：
- `petshop-1.0.0.jar` - 可执行 JAR 包

#### 4. 验证打包结果

```bash
# 查看 JAR 文件大小
ls -lh target/petshop-1.0.0.jar

# 查看 JAR 文件内容
jar tf target/petshop-1.0.0.jar | head -20

# 验证 JAR 文件完整性
jar tf target/petshop-1.0.0.jar > /dev/null && echo "JAR 文件完整"
```

### 打包配置

编辑 `SpringBoot/pom.xml` 中的打包配置：

```xml
<build>
    <plugins>
        <!-- Spring Boot Maven 插件 -->
        <plugin>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-maven-plugin</artifactId>
            <version>3.2.6</version>
            <configuration>
                <mainClass>com.xingluo.petshop.PetshopApplication</mainClass>
            </configuration>
            <executions>
                <execution>
                    <goals>
                        <goal>repackage</goal>
                    </goals>
                </execution>
            </executions>
        </plugin>
    </plugins>
</build>
```

---

## 前端打包

### 前置要求

- Node.js 16.0+
- npm 8.0+

### 打包步骤

#### 1. 安装依赖

```bash
cd VUE

# 清理 node_modules（可选）
rm -rf node_modules package-lock.json

# 安装依赖
npm install
```

#### 2. 配置生产环境

编辑 `VUE/src/utils/request.js`，修改 API 地址为生产环境：

```javascript
const request = axios.create({
  baseURL: 'https://api.petshop.com/api',  // 修改为生产环境地址
  timeout: 5000
})
```

#### 3. 构建项目

```bash
# 生成生产版本
npm run build

# 查看构建结果
ls -lh dist/
```

生成的静态文件位于 `dist/` 目录

#### 4. 验证构建结果

```bash
# 查看构建文件大小
du -sh dist/

# 查看构建文件列表
ls -la dist/

# 验证关键文件
test -f dist/index.html && echo "index.html 存在"
test -f dist/assets/index.*.js && echo "JavaScript 文件存在"
test -f dist/assets/index.*.css && echo "CSS 文件存在"
```

### 构建配置

编辑 `VUE/vite.config.js`：

```javascript
import { defineConfig } from 'vite'
import vue from '@vitejs/plugin-vue'

export default defineConfig({
  plugins: [vue()],
  build: {
    outDir: 'dist',
    assetsDir: 'assets',
    minify: 'terser',
    terserOptions: {
      compress: {
        drop_console: true,
        drop_debugger: true
      }
    },
    rollupOptions: {
      output: {
        manualChunks: {
          'vue': ['vue'],
          'element-plus': ['element-plus']
        }
      }
    }
  },
  server: {
    proxy: {
      '/api': {
        target: 'http://localhost:8080',
        changeOrigin: true
      }
    }
  }
})
```

---

## 部署测试

### 本地部署测试

#### 1. 启动后端

```bash
cd SpringBoot

# 方式一：使用 Maven 插件
mvn spring-boot:run

# 方式二：运行 JAR 包
java -jar target/petshop-1.0.0.jar
```

验证后端启动：

```bash
# 检查端口
lsof -i :8080

# 测试 API
curl http://localhost:8080/api/user/profile
```

#### 2. 启动前端

```bash
cd VUE

# 开发模式
npm run dev

# 或者使用本地服务器运行构建后的文件
npx http-server dist/
```

验证前端启动：

```bash
# 检查端口
lsof -i :5173

# 或者访问浏览器
# http://localhost:5173
```

#### 3. 功能测试

打开浏览器访问 `http://localhost:5173`，进行以下测试：

**用户功能：**
- [ ] 用户注册
- [ ] 用户登录
- [ ] 查看个人资料
- [ ] 修改个人资料

**商品功能：**
- [ ] 浏览商品列表
- [ ] 搜索商品
- [ ] 查看商品详情
- [ ] 查看商品评价

**购物功能：**
- [ ] 添加商品到购物车
- [ ] 查看购物车
- [ ] 修改购物车数量
- [ ] 删除购物车商品
- [ ] 创建订单
- [ ] 查看订单列表
- [ ] 查看订单详情

**社区功能：**
- [ ] 浏览社区帖子
- [ ] 查看帖子详情
- [ ] 发布评论
- [ ] 点赞帖子

**店家功能：**
- [ ] 登录店家账户
- [ ] 查看店铺信息
- [ ] 管理商品
- [ ] 查看订单

**管理员功能：**
- [ ] 登录管理员账户
- [ ] 查看数据看板
- [ ] 管理用户
- [ ] 审核商品

### Docker 部署测试

#### 1. 构建 Docker 镜像

```bash
# 构建后端镜像
cd SpringBoot
docker build -t petshop-backend:1.0.0 .

# 构建前端镜像
cd ../VUE
docker build -t petshop-frontend:1.0.0 .

# 查看镜像
docker images | grep petshop
```

#### 2. 启动 Docker 容器

```bash
# 使用 Docker Compose
docker-compose up -d

# 查看容器状态
docker-compose ps

# 查看日志
docker-compose logs -f backend
docker-compose logs -f frontend
```

#### 3. 验证容器

```bash
# 检查后端容器
docker exec petshop-backend curl http://localhost:8080/api/user/profile

# 检查前端容器
docker exec petshop-frontend curl http://localhost/

# 访问应用
# http://localhost
```

#### 4. 停止容器

```bash
docker-compose down
```

---

## 功能验证

### 用户模块验证

#### 1. 注册功能

```bash
curl -X POST http://localhost:8080/api/user/register \
  -H "Content-Type: application/json" \
  -d '{
    "username": "testuser",
    "password": "test123",
    "email": "test@example.com",
    "phone": "13800000000"
  }'
```

预期响应：
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": 1,
    "username": "testuser",
    "nickname": "testuser",
    "role": "USER"
  }
}
```

#### 2. 登录功能

```bash
curl -X POST http://localhost:8080/api/user/login \
  -H "Content-Type: application/json" \
  -d '{
    "username": "testuser",
    "password": "test123"
  }'
```

预期响应：
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": 1,
    "username": "testuser",
    "nickname": "testuser",
    "role": "USER",
    "token": "user_session_token"
  }
}
```

### 商品模块验证

#### 1. 获取商品列表

```bash
curl http://localhost:8080/api/product/list?page=1&pageSize=10
```

#### 2. 搜索商品

```bash
curl "http://localhost:8080/api/product/search?keyword=狗粮"
```

#### 3. 获取商品详情

```bash
curl http://localhost:8080/api/product/1
```

### 订单模块验证

#### 1. 创建订单

```bash
curl -X POST http://localhost:8080/api/order \
  -H "Content-Type: application/json" \
  -H "Authorization: user_token" \
  -d '{
    "cartIds": [1, 2],
    "receiverName": "张三",
    "receiverPhone": "13800000000",
    "receiverAddress": "北京市朝阳区"
  }'
```

#### 2. 获取订单列表

```bash
curl http://localhost:8080/api/order/list \
  -H "Authorization: user_token"
```

### 社区模块验证

#### 1. 发布帖子

```bash
curl -X POST http://localhost:8080/api/community/post \
  -H "Content-Type: application/json" \
  -H "Authorization: user_token" \
  -d '{
    "title": "我的宠物日常",
    "content": "分享我的宠物生活"
  }'
```

#### 2. 获取帖子列表

```bash
curl http://localhost:8080/api/community/post/list?page=1&pageSize=10
```

---

## 性能测试

### 使用 Apache Bench 进行压力测试

#### 1. 安装 Apache Bench

```bash
# Ubuntu/Debian
sudo apt-get install apache2-utils

# CentOS/RHEL
sudo yum install httpd-tools

# macOS
brew install httpd
```

#### 2. 测试商品列表接口

```bash
# 100 个请求，10 个并发
ab -n 100 -c 10 http://localhost:8080/api/product/list

# 1000 个请求，50 个并发
ab -n 1000 -c 50 http://localhost:8080/api/product/list
```

#### 3. 测试搜索接口

```bash
ab -n 100 -c 10 "http://localhost:8080/api/product/search?keyword=狗粮"
```

### 使用 JMeter 进行性能测试

#### 1. 下载 JMeter

访问 https://jmeter.apache.org/download_jmeter.cgi

#### 2. 创建测试计划

1. 打开 JMeter
2. 创建线程组（Thread Group）
3. 添加 HTTP 请求采样器
4. 配置请求参数
5. 添加监听器（Listener）
6. 运行测试

#### 3. 分析结果

- 平均响应时间
- 最小/最大响应时间
- 吞吐量（Throughput）
- 错误率

### 数据库性能测试

#### 1. 查询性能测试

```sql
-- 测试商品列表查询
SELECT SQL_NO_CACHE * FROM product LIMIT 10;

-- 查看执行计划
EXPLAIN SELECT * FROM product WHERE category_id = 1;

-- 查看查询时间
SET PROFILING = 1;
SELECT * FROM product WHERE category_id = 1;
SHOW PROFILES;
```

#### 2. 索引效果测试

```sql
-- 创建索引前
SELECT COUNT(*) FROM product WHERE name LIKE '%狗粮%';

-- 创建索引
CREATE INDEX idx_product_name ON product(name);

-- 创建索引后
SELECT COUNT(*) FROM product WHERE name LIKE '%狗粮%';
```

---

## 常见问题

### Q: 打包时出现 "找不到主类" 错误

A: 确保 `pom.xml` 中配置了正确的主类：

```xml
<plugin>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-maven-plugin</artifactId>
    <configuration>
        <mainClass>com.xingluo.petshop.PetshopApplication</mainClass>
    </configuration>
</plugin>
```

### Q: 前端构建后文件过大

A: 启用代码分割和压缩：

```javascript
// vite.config.js
build: {
  minify: 'terser',
  rollupOptions: {
    output: {
      manualChunks: {
        'vue': ['vue'],
        'element-plus': ['element-plus']
      }
    }
  }
}
```

### Q: 部署后前端无法连接后端

A: 检查以下几点：
1. 后端是否正常运行
2. 前端 API 地址配置是否正确
3. CORS 是否配置正确
4. 防火墙是否开放了相应端口

### Q: 性能测试结果不理想

A: 尝试以下优化：
1. 添加数据库索引
2. 启用缓存
3. 优化查询语句
4. 增加服务器资源
5. 使用 CDN 加速静态资源

### Q: Docker 容器启动失败

A: 查看容器日志：

```bash
docker logs petshop-backend
docker logs petshop-frontend
```

常见原因：
- 数据库连接失败
- 端口被占用
- 内存不足

---

## 部署检查清单

部署前请确保完成以下检查：

### 后端检查

- [ ] Java 版本正确（17+）
- [ ] Maven 依赖已下载
- [ ] 数据库已初始化
- [ ] 数据库连接配置正确
- [ ] 应用配置文件已更新
- [ ] 日志目录已创建
- [ ] 端口未被占用
- [ ] 防火墙已开放相应端口

### 前端检查

- [ ] Node.js 版本正确（16+）
- [ ] npm 依赖已安装
- [ ] API 地址已配置为生产环境
- [ ] 构建文件已生成
- [ ] 静态文件已上传到服务器
- [ ] Nginx 配置正确
- [ ] SSL 证书已配置

### 数据库检查

- [ ] MySQL 服务已启动
- [ ] 数据库已创建
- [ ] 初始化脚本已执行
- [ ] 用户权限已配置
- [ ] 备份策略已制定

### 系统检查

- [ ] 服务器资源充足
- [ ] 网络连接正常
- [ ] 监控告警已配置
- [ ] 日志收集已配置
- [ ] 备份恢复已测试

---

## 支持

如有问题，请参考：
- 项目 README：README.md
- 部署指南：doc/部署指南.md
- 数据库初始化指南：doc/数据库初始化指南.md
